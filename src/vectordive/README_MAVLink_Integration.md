# MAVLink統合と位置推定機能

この機能は、MAVLinkプロトコルを使用してIMUの加速度データを取得し、二重積分により位置を推定する実装です。

## 概要

- **目的**: MAVLink経由でIMUデータを取得し、位置推定を実行
- **方法**: 加速度 → 速度（積分） → 位置（積分）の二重積分
- **データソース**: MAVLink RAW_IMUメッセージ
- **フォールバック**: MAVLink接続失敗時はモックデータを使用

## 実装内容

### 1. **MAVLink接続機能**

#### `connections/telemetry.py`
- **GetTelemetryクラス**: MAVLink接続とデータ取得を管理
- **接続方式**: UDP (udpin:IP:PORT)
- **対応メッセージ**: RAW_IMU, SERVO_OUTPUT_RAW
- **単位変換**: ミリG → m/s² (× 0.00981)

#### 主要メソッド
- `get_imu_output_acc_data()`: 加速度データ取得
- `get_servo_output_raw_data()`: サーボ出力データ取得
- `is_connected()`: 接続状態確認

### 2. **位置推定エンジン**

#### `workers/telemetry.py`
- **GetVelocityDataクラス**: 二重積分による位置推定
- **積分方式**: 台形積分法
- **データ管理**: 最新100個のデータをキューで保持

#### 主要メソッド
- `get_position_data()`: 位置データ取得（自動積分処理付き）
- `get_current_position()`: 現在の位置取得
- `get_current_velocity()`: 現在の速度取得
- `reset_integration()`: 積分値リセット

### 3. **UI統合**

#### `ui/widgets/position_estimation.py`
- **PositionEstimationWidget**: 位置・速度表示ウィジェット
- **PositionEstimationManager**: 位置推定の管理クラス
- **リアルタイム更新**: 100ms間隔で自動更新

#### 表示内容
- **位置情報**: X, Y, Z座標（メートル単位）
- **速度情報**: VX, VY, VZ（m/s単位）
- **距離・速度の大きさ**: 3次元ベクトルの大きさ
- **接続状態**: MAVLink接続状況の表示

### 4. **MainWindow統合**

#### `ui/main_window.py`
- **位置推定ウィジェット**: テレメトリパネルに統合
- **マップ表示**: 位置推定結果をマップ上に表示
- **キーボードショートカット**: リセット機能

## 使用方法

### 1. **アプリケーション起動**

```bash
export QT_QPA_PLATFORM=xcb && python app.py
```

### 2. **MAVLink接続設定**

1. **EntranceWindow**でIPアドレスとポートを設定
   - デフォルト: IP=0.0.0.0, Port=14550
   - 接続方式: UDP

2. **Connectボタン**をクリック
   - MAVLink接続を試行
   - ハートビート確認
   - 接続成功時はMainWindowに遷移

3. **Debug Modeボタン**（テスト用）
   - 接続確認をスキップ
   - モックデータでテスト実行

### 3. **位置推定の確認**

#### リアルタイム表示
- **位置推定ウィジェット**: リアルタイムで位置・速度を表示
- **マップ表示**: グリッドマップ上に位置マーカーを表示
- **接続状態**: MAVLink接続状況を表示

#### キーボードショートカット
- `Ctrl+Shift+D`: デバッグモード切り替え
- `Ctrl+Shift+T`: テレメトリテストデータ生成
- `Ctrl+Shift+R`: デバッグモードリセット
- `Ctrl+Shift+P`: 位置推定リセット

## テスト機能

### 1. **MAVLink接続テスト**

```bash
python test_mavlink_connection.py
```

選択肢:
- **1**: 基本的なMAVLink接続テスト
- **2**: MAVLinkデータを使った位置推定テスト
- **3**: インタラクティブな接続テスト

### 2. **位置推定テスト**

```bash
python test_position_debug.py
```

### 3. **UIウィジェットテスト**

```bash
python test_ui_widget.py
```

## 技術詳細

### MAVLinkデータ処理

#### データ形式
- **RAW_IMU**: 3軸加速度、角速度、磁場データ
- **単位**: ミリG (1 G = 9.81 m/s²)
- **変換**: `acc_mps2 = acc_millig * 0.00981`

#### 接続処理
1. **接続文字列構築**: `udpin:IP:PORT`
2. **ハートビート待機**: 5秒タイムアウト
3. **データ取得**: 非ブロッキング方式
4. **エラーハンドリング**: 接続失敗時はモックデータ使用

### 積分アルゴリズム

#### 台形積分法
```python
# 加速度の平均値
avg_acc = (current + last) / 2.0

# 速度積分
velocity += avg_acc * delta_time

# 位置積分（速度の平均値を使用）
avg_velocity = (current_velocity + last_velocity) / 2.0
position += avg_velocity * delta_time
```

#### データ管理
- **キューサイズ**: 最新100個のデータを保持
- **時間管理**: `time.time()`を使用
- **メモリ効率**: numpy配列で効率的な計算

### エラーハンドリング

#### 接続エラー
- MAVLink接続失敗時のモックデータ使用
- 接続状態の継続的な監視
- エラーメッセージの詳細表示

#### データエラー
- 無効なデータの検出と処理
- タイムアウト処理
- 例外処理による安全な実行

## 設定

### デフォルト設定 (`config/base.py`)

```python
IP_EDIT_INFO = ["IP Address", "0.0.0.0"]
PORT_EDIT_INFO = ["Port", "14550"]
MODE_COMBO = ["UDP", "Serial"]
```

### 環境変数

```bash
export QT_QPA_PLATFORM=xcb  # Qtプラットフォーム設定
```

## 注意事項

### 1. **MAVLink接続**
- **IPアドレス**: 0.0.0.0で全インターフェースでリッスン
- **ポート**: 14550（MAVLink標準ポート）
- **ファイアウォール**: ポート開放が必要な場合があります

### 2. **位置推定の制限**
- **ドリフト**: 長時間の積分によりドリフトが発生
- **ノイズ**: IMUノイズが積分により増幅
- **重力**: 重力加速度の補正は未実装
- **テスト用途**: 実際の運用では追加の補正が必要

### 3. **パフォーマンス**
- **更新頻度**: 100ms間隔で更新
- **メモリ使用量**: 最新100個のデータを保持
- **CPU使用量**: リアルタイム積分計算

## 今後の改善点

### 1. **精度向上**
- **重力補正**: 重力加速度の除去
- **フィルタリング**: カルマンフィルタの適用
- **ドリフト補正**: ゼロ速度更新の実装

### 2. **機能拡張**
- **センサフュージョン**: 他のセンサーとの組み合わせ
- **データ記録**: 位置推定データの保存
- **可視化**: 3D軌跡表示

### 3. **安定性向上**
- **再接続機能**: 接続断時の自動再接続
- **データ検証**: データ品質の検証
- **エラー回復**: より堅牢なエラー処理

## 依存関係

- `pymavlink`: MAVLinkプロトコル処理
- `numpy`: 数値計算
- `PyQt5`: GUIフレームワーク
- `matplotlib`: グラフ表示（テスト用）

## トラブルシューティング

### 1. **接続エラー**
- IPアドレスとポートの確認
- ファイアウォール設定の確認
- MAVLinkデバイスの動作確認

### 2. **データが取得できない**
- MAVLinkメッセージの確認
- デバイスの設定確認
- モックデータでの動作確認

### 3. **UIが表示されない**
- Qtプラットフォームの設定確認
- 環境変数の設定確認
- 依存関係のインストール確認
